# Todo.md

## 包月管理系統開發執行順序

### 階段一：資料庫結構調整

- [x] 修改 Subscription 表結構 <!-- 已完成，SQL/10-Table/Subscription.sql 已同步 -->
  - [x] 新增包月類型欄位 (SubscriptionType: BATH/GROOM/MIXED)
  - [x] 新增總次數限制欄位 (TotalUsageLimit)
  - [x] 新增已使用次數欄位 (UsedCount)
  - [x] 新增預留次數欄位 (ReservedCount)
  - [x] 新增包月狀態欄位 (Status: ACTIVE/PAUSED/EXPIRED/CANCELLED)
  - [x] 新增價格欄位 (SubscriptionPrice)
  - [x] 新增備註欄位 (Notes)

- [x] 修改 ReserveRecord 表結構 <!-- 已完成，SQL/10-Table/ReserveRecord.sql 已同步 -->
  - [x] 新增預約狀態欄位 (Status: PENDING/CONFIRMED/IN_PROGRESS/COMPLETED/CANCELLED/NO_SHOW)
  - [x] 修正 PetId 外鍵關聯（目前已存在但需檢查約束）
  - [x] 新增服務總價欄位 (TotalAmount)
  - [x] 新增是否使用包月欄位 (UseSubscription)
  - [x] 確保資料完整性約束

- [x] 新增包月類型配置表 (SubscriptionType) <!-- 已完成，SQL/10-Table/SubscriptionType.sql 已同步 -->
  - [x] 包月類型代碼和名稱
  - [x] 預設次數和價格配置
  - [x] 可用服務類型配置

- [x] 新增通知記錄表 (NotificationLog) <!-- 已完成，SQL/10-Table/NotificationLog.sql 已同步 -->
  - [x] 通知類型（到期提醒、次數不足等）
  - [x] 發送狀態和時間記錄
  - [x] 關聯的訂閱或寵物ID

- [x] 強化 PaymentRecord 與 Subscription 關聯 <!-- 已完成，SQL/10-Table/PaymentRecord.sql 已同步 -->
  - [x] 新增 SubscriptionId 外鍵欄位
  - [x] 新增付款類型標識

### 階段二：後端模型和 DTO 調整

- [x] 更新 Entity Models <!-- 已完成，所有 Entity Model 已同步 Schema 並具備必要屬性 -->
  - [x] 重新生成 Subscription.cs 和 ReserveRecord.cs
  - [x] 確保新欄位的屬性對應正確

- [x] 更新 DTO 類別 <!-- 已完成，DTO 已含包月使用次數、狀態、包月選擇、驗證等資訊 -->
  - [x] 修改 SubscriptionDto.cs 加入使用次數資訊
  - [x] 修改 ReservationDto.cs 加入狀態和包月選擇邏輯
  - [x] 新增包月驗證和計算相關 DTO

### 階段三：核心服務邏輯實作

- [x] 增強 SubscriptionService <!-- 已完成，實作包月次數預留/釋放/確認/檢查/狀態更新 -->
  - [x] 實作包月次數預留/釋放/確認機制
  - [x] 新增包月可用性檢查方法
  - [x] 實作包月狀態自動更新邏輯

- [x] 增強 ReservationService <!-- 已完成，整合包月次數流轉與狀態變更處理 -->
  - [x] 修改建立預約邏輯（預留包月次數）
  - [x] 實作預約狀態變更處理
  - [x] 新增預約完成時的包月次數扣除

- [x] 新增服務類型判斷邏輯 <!-- 已完成，實作ServiceTypeService -->
  - [x] 實作根據 ServiceType 判斷洗澡/美容
  - [x] 處理美容服務的複合扣除邏輯（1美容+3洗澡）

### 階段四：API 控制器調整

- [x] 更新 SubscriptionController <!-- 已完成，新增包月預留/釋放/確認等API -->
  - [x] 新增包月使用情況查詢 API
  - [x] 新增包月驗證 API
  - [x] 更新現有 CRUD 操作以支援新欄位

- [x] 更新 ReservationController <!-- 已完成，支援包月選擇與狀態變更 -->
  - [x] 修改預約建立 API 支援包月選擇
  - [x] 新增預約狀態變更 API
  - [x] 新增預約完成處理 API

### 階段五：前端界面調整 ✅

- [x] 更新包月管理頁面 <!-- 已完成，建立功能完整的包月列表組件 -->
  - [x] 新增包月狀態顯示（彩色標籤）
  - [x] 實作包月歷史記錄查看（時間軸顯示）
  - [x] 包月類型選擇和比較功能
  - [ ] 批量包月購買功能
  - [x] 包月使用情況視覺化圖表

- [x] 更新預約相關頁面 <!-- 已完成，更新ReservationList.vue與ReservationForm.vue -->
  - [x] 預約建立時的包月選擇功能
  - [x] 預約列表顯示包月使用狀態
  - [x] 預約狀態變更操作介面
  - [x] 包月次數即時更新顯示

- [x] 新增儀表板統計 <!-- 已完成，建立SubscriptionDashboard.vue -->
  - [x] 包月使用情況統計圖表
  - [x] 即將到期包月提醒卡片
  - [x] 包月收入統計分析
  - [x] 包月銷售趨勢圖表
  - [x] 包月客戶價值分析

- [x] 前端類型安全優化 <!-- 已完成，修復TypeScript編譯錯誤 -->
  - [x] Vue組件類型定義完善
  - [x] 介面型別規範建立
  - [x] 編譯錯誤修復完成

- [x] API測試工具建立 <!-- 已完成，建立完整的API測試腳本 -->
  - [x] 包月服務API測試
  - [x] 預約服務API測試
  - [x] 併發測試腳本
  - [x] 效能測試工具

- [ ] 行動端響應式優化
  - [ ] 包月管理的行動端設計
  - [ ] 包月快速查詢功能
  - [ ] 離線包月狀態顯示

### 階段六：測試和驗證

- [ ] 單元測試
  - [ ] 包月次數計算邏輯測試
  - [ ] 預約狀態變更測試
  - [ ] 併發情況處理測試
  - [ ] 包月到期邏輯測試
  - [ ] 財務計算邏輯測試

- [ ] 整合測試
  - [ ] 完整預約流程測試
  - [ ] 包月使用流程測試
  - [ ] 資料一致性驗證
  - [ ] 第三方整合測試

- [ ] 效能測試
  - [ ] 大量併發包月使用測試
  - [ ] 資料庫查詢效能測試
  - [ ] 快取機制效能驗證

- [ ] 用戶驗收測試
  - [ ] 實際業務場景測試
  - [ ] 使用體驗和介面測試
  - [ ] 行動端功能測試

### 階段七：業務邏輯增強（新增）

- [ ] 通知系統實作
  - [ ] 包月即將到期提醒機制
  - [ ] 包月次數不足提醒
  - [ ] 自動續約提醒和處理
  - [ ] 簡訊/郵件通知整合

- [ ] 財務整合強化
  - [ ] 包月退費處理機制
  - [ ] 部分使用退費計算邏輯
  - [ ] 包月收入分攤和會計處理
  - [ ] 財務報表整合

- [ ] 包月類型管理系統
  - [ ] 包月類型的動態配置
  - [ ] 包月升級/降級機制
  - [ ] 包月組合方案設計

### 階段八：效能與安全優化（新增）

- [ ] 併發控制增強
  - [ ] 樂觀鎖定 (Optimistic Locking) 實作
  - [ ] 分散式鎖定機制（Redis實作）
  - [ ] 包月使用的事務一致性保證

- [ ] 效能優化
  - [ ] 包月使用情況的快取機制（Redis）
  - [ ] 大量包月查詢的分頁優化
  - [ ] 統計資料的預計算和快取
  - [ ] 資料庫查詢最佳化

- [ ] 安全性強化
  - [ ] 包月資料的存取權限控制
  - [ ] 包月操作的審計日誌
  - [ ] 包月資料的加密存儲
  - [ ] 包月欺詐檢測機制

### 階段九：運營管理工具（新增）

- [ ] 分析報表系統
  - [ ] 包月銷售趨勢分析
  - [ ] 包月使用行為分析
  - [ ] 包月客戶價值分析
  - [ ] 包月流失預警機制

- [ ] 系統監控
  - [ ] 包月系統健康監控
  - [ ] 異常使用模式檢測
  - [ ] 包月服務效能監控
  - [ ] 包月錯誤日誌追蹤

- [ ] 資料管理
  - [ ] 歷史資料清理策略
  - [ ] 包月資料歸檔機制
  - [ ] 資料修復工具

### 階段十：系統整合（新增）

- [ ] 第三方整合
  - [ ] 第三方支付系統整合
  - [ ] 客戶關係管理 (CRM) 整合
  - [ ] 會員系統整合
  - [ ] 庫存管理系統整合

- [ ] API擴展
  - [ ] 開放API設計和實作
  - [ ] Webhook支援
  - [ ] API版本管理

- [ ] 部署和維運
  - [ ] Docker容器化
  - [ ] CI/CD流程建立
  - [ ] 監控和日誌系統
  - [ ] 備份和災難恢復

### 🎯 開發重點提醒

**核心階段（必須完成）：**
- 階段1-3：基礎設施，必須優先完成
- 階段4-6：核心邏輯和測試，是系統功能的關鍵

**增強階段（建議完成）：**
- 階段7-8：業務邏輯增強和效能優化
- 階段9-10：運營管理和系統整合

**執行策略：**
1. 先完成階段1-6的核心功能
2. 根據業務需求決定階段7-10的優先級
3. 每個階段完成後進行測試驗證
4. 建議採用敏捷開發方式，分批交付功能

**風險控制：**
- 資料庫結構變更需要謹慎規劃
- 併發控制是關鍵技術難點
- 效能優化需要持續監控和調整